define(["backbone","zepto","m-user","user-tpl","modal"],function(Backbone,$,Login,TplLogin,Modal){var login=new Login,$login,Vlogin=Backbone.View.extend({el:"#wrap",initialize:function(){login.unbind(),login.bind("change:isOn",this.login_call),login.bind("change:msg",this.msg_call)},events:{"click .login":"show","click .exit":"exit","click .btn-login":"fun_login"},login_call:function(e){var tpl_login='<i class="icon user"></i><a href="#" class="username">{{username}}</a> | <a href="#" class="exit">\u9000\u51fa</a>',tpl_exit='<p class="no-login"><a href="#" class="login">\u767b\u5f55</a> | <a href="#" class="exit">\u9000\u51fa</a></p>';e.changed.isOn?(console.log(e),$(".quick_user img").attr("src",e.attributes.imgurl).attr("title",e.attributes.userName)):$(".profile").html(tpl_exit)},fun_login:function(e){e&&e.preventDefault(),console.log("is loging");var user=$("#user").val(),pwd=$("#pwd").val(),captcha=$("#captcha");captcha=captcha.is(":visible")?captcha.val():"",login.login(user,pwd,1
,captcha)},msg_call:function(e){if(e.attributes.msg!="ok"){var msg=e.attributes.msg.replace(/\:t\=\d+/g,"");msg.indexOf("\u9a8c\u8bc1")>-1&&$login.find(".auth").show(),msg&&$login.find(".error .header").html(msg).parent().show(),$login.find(".auth img").trigger("click")}else $login.modal("hide").remove()},show:function(e){e&&e.preventDefault(),$.pgwModal({title:"\u5e10\u53f7\u767b\u5f55",maxWidth:390,content:TplLogin({user:login.attributes.userName})})},exit:function(e){e&&e.preventDefault(),login.exit()}});return Vlogin});